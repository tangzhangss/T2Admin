var tempLayeroForFillReport,tempTableInfoRorFillReport,tempCellRorFillReport=new Array,settingForFillReport={view:{showLine:!1,addDiyDom:addDiyDomForFillReport,addHoverDom:addHoverDomForFillReport,removeHoverDom:removeHoverDomForFillReport},data:{simpleData:{enable:!0}},edit:{enable:!0,showRenameBtn:!1,showRemoveBtn:function(e,t){return 1==t.level},removeTitle:"删除",drag:{autoExpandTrigger:!0,prev:!1,inner:!1,next:!1,isCopy:!0,isMove:!1}},callback:{beforeDrag:beforeDragForFillReport,onClick:zTreeOnClickForFillReport,beforeRemove:zTreeBeforeRemoveForFillReport}},zNodesForFillReport=[{id:0,name:"填报配置列表",open:!0}];function getDataFillReportNodesByParam(e,t,l){return $.fn.zTree.getZTreeObj("fillReport").getNodesByParam(e,t,l)}function addDiyDomForFillReport(e,t){0==t.level&&$("#"+t.tId+"_a").append('<button type="button" class="tb_btn" id="addFillReportBtn" onclick="addDataFillReport()">添加配置</button>')}function zTreeOnClickForFillReport(e,t,l){}function beforeDragForFillReport(e,t){return 1==t[0].level}function zTreeBeforeRemoveForFillReport(e,t){return layer.confirm("确认删除配置  “"+t.name+"” 吗？",{btn:["确定","取消"]},function(e){$.fn.zTree.getZTreeObj("fillReports").removeNode(t),layer.alert("删除成功!")},function(e){layer.close(e)}),!1}function addHoverDomForFillReport(e,t){if(1!=t.level)return!1;var l,o=$("#"+t.tId+"_span");t.editNameFlag||0<$("#"+t.tId+"_editBtn").length||(l="<span class='button edit' id='"+t.tId+"_editBtn' title='修改' onfocus='this.blur();'></span>",o.after(l),(l=$("#"+t.tId+"_editBtn"))&&l.bind("click",function(){return addDataFillReport(t),!1}))}function removeHoverDomForFillReport(e,t){if(1!=t.level)return!1;$("#"+t.tId+"_editBtn").unbind().remove()}function CellRorFillReport(){tempCellRorFillReport=new Array;var e=getTabelData();null!=e&&null!=e.row&&$.each(e.row,function(e,t){$.each(t.col,function(e,t){null!=t.fill&&null!=t.fill.ctName&&tempCellRorFillReport.push(t.fill.ctName)})})}function addDataFillReport(l){tempTableInfoRorFillReport=[],CellRorFillReport(),layer.open({type:1,area:["535px","510px"],maxmin:!0,title:"填报配置",content:$("#fillReportInfo"),cancel:function(){},success:function(o,e){(tempLayeroForFillReport=o).find("#fillName").val(""),o.find("#btnType").val(""),o.find("#actionurl").val(""),o.find("#DataSourceName").empty(),o.find("#DataSourceName").append("<option value=''> </option>"),o.find("#tbName").empty(),o.find("#tbName").append("<option value=''> </option>"),o.find("#columu_cell").empty(),o.find("#btnType").unbind().bind("change",function(){"actionurl"==$(this).val()?(o.find(".actionbtn").hide(),o.find(".actionurl").show(),o.find("#DataSourceName").val(""),o.find("#tbName").empty(),o.find("#columu_cell").empty(),tempTableInfoRorFillReport=[]):(o.find("#actionurl").val(""),o.find(".actionurl").hide(),o.find(".actionbtn").show())}),$.rdp.ajax({url:"../../rdp/selectAllDataSourceName",type:"post",async:!1,success:function(e){for(var t=e.list,l=0;l<t.length;l++)t[l].readOnly&&o.find("#DataSourceName").append("<option value='"+t[l].dataSourceName+"'>"+t[l].dataSourceName+"</option>")},beforeSend:function(){layer.load()},complete:function(){layer.closeAll("loading")}}),o.find("#DataSourceName").unbind().bind("change",function(){var e=$(this);""!=e.val()?$.rdp.ajax({url:"../../rdp/getTableInfo?dataSourceName="+e.val(),type:"post",async:!1,success:function(e){if(0==e.code&&null!=e.list)for(var t=e.list,l=0;l<t.length;l++)o.find("#tbName").append("<option value='"+t[l].tableName+"'>"+t[l].tableName+"["+t[l].tableComments+"]</option>")},beforeSend:function(){layer.load()},complete:function(){layer.closeAll("loading")}}):(o.find("#tbName").empty(),o.find("#tbName").append("<option value=''> </option>"))}),o.find("#tbName").unbind().bind("change",function(){var e=$(this);""!=e.val()?$.rdp.ajax({url:"../../rdp/getColumnInfo?dataSourceName="+o.find("#DataSourceName").val()+"&tableName="+e.val(),type:"post",async:!1,success:function(e){tempTableInfoRorFillReport=e.list},beforeSend:function(){layer.load()},complete:function(){layer.closeAll("loading")}}):tempTableInfoRorFillReport=[]}),l?setDomAllVals(o[0],l):setDomAllVals(o[0])},end:function(){},btn:["提交","取消"],yes:function(e,t){(l?addFillReportNode(t,l):addFillReportNode(t))&&layer.close(e)},btn2:function(e,t){layer.close(e)}})}function addFillReportNode(e,t){var l=getDomAllVals(e[0]);if(""==l.name)return window.top.layer.tips("请输入配置名称",$(e).find("#fillName"),{tipsMore:!0}),!1;if("actionurl"!=l.btnType){if(""==l.dataSourceName)return window.top.layer.tips("数据源不能为空",$(e).find("#DataSourceName"),{tipsMore:!0}),!1;if(""==l.tbName)return window.top.layer.tips("对应表不能为空",$(e).find("#tbName"),{tipsMore:!0}),!1}var o,n=$.fn.zTree.getZTreeObj("fillReports"),e=n.getNodes(),a=t?$.extend(!0,t,l):$.extend(!0,{},l);return t?(o=n.getNodesByParam("name",a.name,null),n.removeChildNodes(o[0]),(a.fields.length=0)<$("#columu_cell tr").length&&$("#columu_cell tr").each(function(e,t){var l={};l.name=$(this).find('td[name="column"]').text()+"<--"+$(this).find('td[name="cell"]').text(),l.primary=$(this).find('input[name="primary"]').is(":checked")?"1":"0",l.foreign=$(this).find('input[name="foreign"]').is(":checked")?"1":"0",l.column=$(this).find('td[name="column"]').text(),l.cell=$(this).find('td[name="cell"]').text(),l.remark=$(this).find('td[name="remark"]').text(),a.fields.push(l)})):(e=n.getNodes(),o=n.addNodes(e[0],a)),"actionurl"!=l.btnType&&n.addNodes(o[0],a.fields),!0}function getColumnSelect(l){var o='<select onblur="$(this).parent().text($(this).val())">';return null!=tempTableInfoRorFillReport&&0<tempTableInfoRorFillReport.length&&$.each(tempTableInfoRorFillReport,function(e,t){o+='<option value="'+t.columnName+'"',t.columnName==l&&(o+=' selected="selected"'),o+=">"+t.columnName+"</option>"}),o+="</select>"}function getCellSelect(l){var o='<select onblur="$(this).parent().text($(this).val())">';return null!=tempCellRorFillReport&&0<tempCellRorFillReport.length&&$.each(tempCellRorFillReport,function(e,t){o+='<option value="'+t+'"',t==l&&(o+=' selected="selected"'),o+=">"+t+"</option>"}),o+="</select>"}function addAllFillReportColumn(){null!=tempTableInfoRorFillReport&&0<tempTableInfoRorFillReport.length&&$.each(tempTableInfoRorFillReport,function(e,t){null!=t.columnName&&0<t.columnName.length&&0==$('#columu_cell tr[name="'+t.columnName+'"]').length&&$("#columu_cell").append('<tr name="'+t.columnName+'" align="center"><td><input type="checkbox" name="primary"></td><td><input type="checkbox" name="foreign"></td><td name="column">'+t.columnName+'</td><td name="cell"></td><td name="remark"></td></tr>')}),bindFillReport()}function deleteAllFillReportColumn(){layer.confirm("确实要清空所有配置吗？",function(e){$("#columu_cell").empty(),layer.close(e)})}function addFillReportColumn(){0<tempTableInfoRorFillReport.length&&0<tempCellRorFillReport.length?($("#columu_cell").append('<tr align="center"><td><input type="checkbox" name="primary"></td><td><input type="checkbox" name="foreign"></td><td name="column"></td><td name="cell"></td><td name="remark"></td></tr>'),bindFillReport()):alert("不存在对应关系")}function deleteFillReportColumn(){$("#columu_cell tr.hover").detach()}function bindFillReport(){$("#columu_cell tr").off().on("click",function(){$("#columu_cell tr").removeClass("hover"),$(this).addClass("hover")}),$('#columu_cell td[name="column"]').off().on("dblclick",function(){var e=getColumnSelect($(this).text());$(this).html(e),$(this).find("select").focus()}),$('#columu_cell td[name="cell"]').off().on("dblclick",function(){var e=getCellSelect($(this).text());$(this).html(e),$(this).find("select").focus()}),$('#columu_cell td[name="remark"]').off().on("dblclick",function(){var e=$(this).text();$(this).html('<input placeholder="请输入备注" value="'+e+'" onblur="$(this).parent().text($(this).val())" />'),$(this).find("input").focus()})}