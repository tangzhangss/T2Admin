var dataLinkLayero,parmstr="",filestr="",datalinkparmData={};function addLink(){var t=hot.Methods.getSelected();if(t){var t=t[0],r=hot.Methods.getCellMeta(t[0],t[1]),t=hot.Methods.getDataAtCell(t[0],t[1]);if(!t)return layer.msg("当前单元格未配置字段"),!1;var p=t.substring(1,t.length).split(".");layer.open({type:1,area:["600px","480px"],title:"配置超链接",content:$("#dataLink"),cancel:function(){},success:function(i,t){datalinkparmData={},(dataLinkLayero=i).find("#temlist").empty(),i.find("#plist").empty(),i.find("#myconfig").val(""),i.find("#temlist").append("<option value='' >请选择</option>");var l="";filestr="";var a=r.link;if(a){i.find("#myconfig").val(a);for(var e=a.split(","),n=0;n<e.length;n++){var o=e[n].split(":");"url"==o[0]?l=o[1].replace("show/",""):o[1]&&-1<o[1].indexOf("(#=")?datalinkparmData[o[0]]=o[1].replace("(#=","").replace("#)",""):datalinkparmData[o[0]]=o[1]}}""!=l&&$.rdp.ajax({url:"../../rdp/selectAllParmsByUUID",type:"post",data:{uuid:l},async:!1,success:function(t){var a,t=t.list;for(a in parmstr="",t)parmstr+="<option value="+a+">"+a+"</option>"}});var s=$.fn.zTree.getZTreeObj("dataSets"),a=s.getNodeByParam("dataSetName",p[0],null),a=s.getNodeByParam("type","field",a).children;$.each(a,function(t,a){filestr+="<option value="+p[0]+"."+a.columnName+">"+p[0]+"."+(a.columnComments||a.columnName)+"</option>"}),$.each(datalinkparmData,function(t,a){"url"!=t&&"reporttype"!=t&&"parms"!=t&&addp(a,t)}),$.rdp.ajax({url:"../../rdp/selectAllReportFile?kw=",type:"post",success:function(t){var a,e=t.list;for(a in e){var n="";l==e[a].uuid&&(n=" selected = 'selected'"),i.find("#temlist").append("<option value='"+e[a].uuid+"' "+n+">"+e[a].name+"</option>")}$("#padd").show()}}),i.find("#temlist").bind("change",function(){var t=this.value.split(",")[0];i.find("#plist").empty(),$.rdp.ajax({url:"../../rdp/selectAllParmsByUUID",type:"post",data:{uuid:t},success:function(t){var a,t=t.list;for(a in parmstr="",t)parmstr+="<option value="+a+">"+a+"</option>"}})})},end:function(){dataLinkLayero=null,console.log("销毁layer")},btn:["保存","取消"],yes:function(t,a){var e=hot.Methods.getSelected();e&&(e=e[0],hot.Methods.getCellMeta(e[0],e[1]),hot.Methods.setCellMeta(e[0],e[1],"link",dataLinkLayero.find("#myconfig").val())),console.log("保存"),layer.close(t)},btn2:function(t,a){layer.close(t)}})}}function createlink(){var e="url:show/"+dataLinkLayero.find("#temlist").val()+",";dataLinkLayero.find("#plist").find(".top").each(function(){var t=$(this).find(".filelist")[0].value,a=$(this).find(".parmlist")[0].value;e+=a+":(#="+t+"#),"}),dataLinkLayero.find("#myconfig").val(e.substring(0,e.length-1))}function addp(t,a){var e=(new Date).getTime(),n='<div class="top"><span><select name="parmlist" class="parmlist" id="parmlist'+e+'"><option value="">请选择参数</option>'+parmstr+'</select></span><span>=</span><span><select name="filelist" class="filelist" id="filelist'+e+'"><option value="">请选择字段</option>'+filestr+'</select></span><span><input type="button" class="pdel" value="删除" onclick="$(this).parent().parent(\'div\').remove();" /></span></div>';dataLinkLayero.find("#plist").append(n),dataLinkLayero.find("#filelist"+e).val(t),dataLinkLayero.find("#parmlist"+e).val(a)}function removeLink(){var t=hot.Methods.getSelected();t&&(t=t[0],(t=hot.Methods.getCellMeta(t[0],t[1])).link="",delete t.link)}