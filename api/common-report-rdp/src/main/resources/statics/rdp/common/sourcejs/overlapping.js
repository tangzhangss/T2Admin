var tempOverlapping;function setOverlapping(){var s,c,n,e=hot.Methods.getSelected(),d={};e&&(s=e[0],c=hot.Methods.getCellMeta(s[0],s[1]),n=hot.Methods.getCell(s[0],s[1]),d=c.overlapping||{},layer.open({type:1,area:["700px","410px"],title:"交叉表头配置",content:$("#overlapping"),cancel:function(){},success:function(e,t){(tempOverlapping=e).find("#view-border").width($(n).outerWidth()).height($(n).outerHeight()-1),e.find("#lineHeight").val($(n).outerHeight()-1),e.find("#lineWidth").val($(n).outerWidth()),e.find("#view-td").css("background-image","").empty(),e.find("#line").val(0),e.find("#overlap-items").empty(),e.find("#lineHeight").bind("input propertychange",function(){e.find("#view-border").height($(this).val())}),e.find("#lineWidth").bind("input propertychange",function(){e.find("#view-border").width($(this).val())}),e.find("#line").bind("change",function(){createItmes($(this).val())}),e.find("#viewOverlap").bind("click",function(){createViewLine()}),e.find("#overlapping-fontsize").bind("change input",function(){$(".overlap-node").css("font-size",this.value+"px")}),e.find(".overlapping-color").spectrum({showInput:!0,allowEmpty:!0,showAlpha:!0,cancelText:"取消",chooseText:"确认",togglePaletteMoreText:"更多",togglePaletteLessText:"简略",change:function(e){"overlapping-bgcolor"==this.id?$("#view-td").css("background-color",e.toRgbaString()):"overlapping-fontcolor"==this.id?$(".overlap-node").css("color",e.toRgbString()):"overlapping-linecolor"==this.id&&line(tempOverlapping.find("#view-td")[0],1,e.toRgbaString(),$("#line").val())},show:function(e){},move:function(e){}}),initOverlapping(d,e)},end:function(){},btn:["保存","取消"],yes:function(a,r){var p=tempOverlapping.find("#view-td");html2canvas(p[0]).then(function(e){d.base64=e.toDataURL(),d.nodes=[],p.find(".overlap-node").each(function(){var e={};e.top=$(this).css("top"),e.left=$(this).css("left"),e.value=$(this).text(),d.nodes.push(e)}),c.overlapping=d,hot.Methods.setCellMetaObject(s[0],s[1],c);var e=hot.Methods.getCell(s[0],s[1]),t=Number($(e).attr("rowspan")?$(e).attr("rowspan"):0),n=Number($(e).attr("colspan")?$(e).attr("colspan"):0),o=r.find("#lineWidth").val(),i=r.find("#lineHeight").val();if(1<t)for(var l=1;l<t;l++)i-=hot.Methods.getRowHeight(s[0]+l);if(1<n)for(l=1;l<n;l++)o-=hot.Methods.getColWidth(s[1]+l);TableData.rowHeights[s[0]]=Number(i),TableData.colWidths[s[1]]=Number(o),tb_updateSettings(),tb_width(o),tb_height(i),layer.close(a)})},btn2:function(e,t){layer.close(e)}}))}function clearoverlapping(){var e,t=hot.Methods.getSelected();t&&(e=t[0],t=hot.Methods.getCell(e[0],e[1]),delete hot.Methods.getCellMeta(e[0],e[1]).overlapping,t.style.backgroundImage="")}function initOverlapping(e,t){t.find("#overlapping-bgcolor").spectrum("set",e.bgcolor||"#ffffff"),t.find("#overlapping-fontcolor").spectrum("set",e.fontcolor||"#000000"),t.find("#overlapping-linecolor").spectrum("set",e.linecolor||"#000000");var n=e.nodes;n&&1<n.length&&(t.find("#line").val(n.length-1),createItmes(n.length-1,n),createViewLine(n)),$("#view-td").css("background-color",e.bgcolor||"#ffffff"),$(".overlap-node").css("color",e.fontcolor||"#000000")}function createItmes(e,t){var n=tempOverlapping.find("#overlap-items");n.empty();for(var o,i=0;i<Number(e)+1;i++)o=t?$('<div class="linenames-div"><input type="text" value="'+t[i].value+'" name="linenames" placeholder="请输入第'+(i+1)+'个参数" /></div>'):$('<div class="linenames-div"><input type="text" name="linenames" placeholder="请输入第'+(i+1)+'个参数" /></div>'),n.append(o)}function createViewLine(e){var t,n=tempOverlapping.find("#view-td"),o=$("#overlapping-linecolor").spectrum("get").toRgbaString();e?(line(n[0],1,o,e.length-1),addLabels(n,e)):(e=tempOverlapping.find(".linenames-div"),t=[],$.each(e,function(){var e={};e.value=$(this).find("[name=linenames]").val(),t.push(e)}),line(n[0],1,o,e.length-1),addLabels(n,t))}function addLabels(o,e){o.empty(),$.each(e,function(e,t){var n=$('<label class="overlap-node">'+t.value+"</label>");n.appendTo(o),n.myDrag({randomPosition:!1,direction:"all",handler:!1,elem:o}),t.top&&n.css("top",t.top),t.left&&n.css("left",t.left),n.css("color",$("#overlapping-fontcolor").spectrum("get").toRgbString()),n.css("font-size",$("#overlapping-fontsize").val()+"px")})}function createLine(e,t,n){var o;!e&&0<=t&0<=n?(e=hot.Methods.getCellMeta(t,n).overlapping,o=hot.Methods.getCell(t,n,!1),e.base64=line(o,1,"#000000",e.val),hot.Methods.setCellMeta(t,n,"overlapping",e)):(n=hot.Methods.getSelected())&&(n=n[0],hot.Methods.getCellMeta(n[0],n[1]),o=hot.Methods.getCell(n[0],n[1],!1),e.base64=line(o,1,"#000000",e.val),hot.Methods.setCellMeta(n[0],n[1],"overlapping",e),TableData.overlapping[n[0]]||(TableData.overlapping[n[0]]=[]),TableData.overlapping[n[0]][n[1]]=e.val)}function line(e,t,n,o){var i=e.clientWidth,l=e.clientHeight,a=document.createElement("CANVAS");a.width=i,a.height=l;var r=a.getContext("2d");switch(r.clearRect(0,0,i,l),r.fill(),r.lineWidth=t,r.strokeStyle=n,r.beginPath(),Number(o)){case 1:r.moveTo(0,0),r.lineTo(i,l);break;case 2:r.moveTo(0,0),r.lineTo(i/2,l),r.moveTo(0,0),r.lineTo(i,l/2);break;case 3:r.moveTo(0,0),r.lineTo(i,l),r.moveTo(0,0),r.lineTo(i/2,l),r.moveTo(0,0),r.lineTo(i,l/2);break;default:return 0}r.stroke(),r.closePath();o=r.canvas.toDataURL();return e.style.backgroundImage='url("'+o+'")',e.style.backgroundRepeat="no-repeat",$(a).remove(),o}